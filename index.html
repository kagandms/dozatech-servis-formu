<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dozatech Servis Formu</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dozatech Servis Formu">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="manifest" href="manifest.json">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="fonts.js"></script>

    <style>
        /* CSS Variables - DozaTech Theme */
        :root {
            --primary-color: #4cc9f0;
            --primary-dark: #00b4d8;
            --primary-light: #90e0ef;
            --accent-color: #0077b6;
            --success-color: #06d6a0;
            --warning-color: #ffd166;
            --danger-color: #ef476f;
            --bg-dark: #0a0a14;
            --bg-card: #12121f;
            --bg-card-hover: #1a1a2e;
            --bg-input: #0d0d18;
            --text-primary: #ffffff;
            --text-secondary: #b8c5d6;
            --text-muted: #6b7a8f;
            --border-radius: 16px;
            --border-radius-sm: 12px;
            --border-radius-xs: 8px;
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 30px rgba(76, 201, 240, 0.2);
            --transition-fast: 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 19px;
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0d1520 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f1629 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-box {
            background: var(--bg-card);
            padding: 40px 32px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow-soft), 0 0 60px rgba(76, 201, 240, 0.1);
            border: 1px solid rgba(76, 201, 240, 0.2);
            max-width: 320px;
            width: 90%;
        }

        .login-logo {
            max-width: 200px;
            margin-bottom: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
        }

        .login-logo img {
            width: 100%;
            display: block;
        }

        .login-box h2 {
            color: var(--text-primary);
            margin: 0 0 24px 0;
            font-size: 1.3rem;
        }

        .login-box input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            background: var(--bg-input);
            border: 1px solid rgba(76, 201, 240, 0.2);
            border-radius: var(--border-radius-xs);
            color: white;
            font-size: 1rem;
            text-align: center;
        }

        .remember-me-container {
            margin-bottom: 20px;
            text-align: left;
            padding-left: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remember-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
            cursor: pointer;
        }

        .login-box button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: var(--bg-dark);
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .error-msg {
            color: #ef4444;
            font-size: 0.9rem;
            margin-top: 12px;
            min-height: 20px;
        }

        /* App Container */
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 12px;
            padding-bottom: 80px;
        }

        /* Logo Section */
        .logo-section {
            text-align: center;
            padding: 20px 8px;
            margin-bottom: 16px;
        }

        .logo-container {
            display: inline-block;
            background: white;
            padding: 16px 28px;
            border-radius: 20px;
            box-shadow: var(--shadow-soft), 0 0 50px rgba(76, 201, 240, 0.2);
        }

        .logo-image {
            max-width: 280px;
            height: auto;
            display: block;
        }

        /* Sections */
        .customer-section,
        .counter-section,
        .notes-section {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(76, 201, 240, 0.1);
            margin-bottom: 16px;
        }

        .customer-section h2,
        .notes-section h2 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .customer-section h2::before,
        .notes-section h2::before {
            content: '';
            width: 3px;
            height: 16px;
            background: linear-gradient(180deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .customer-controls {
            display: flex;
            gap: 10px;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(76, 201, 240, 0.2);
            border-radius: var(--border-radius-xs);
            background: var(--bg-input);
            color: white;
            flex: 1;
        }

        .secondary-btn {
            padding: 0 20px;
            background: var(--bg-input);
            border: 1px solid rgba(76, 201, 240, 0.2);
            color: var(--primary-color);
            border-radius: var(--border-radius-xs);
            cursor: pointer;
        }

        /* Counter Section */
        .counter-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .counter-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon-box {
            font-size: 1.5rem;
        }

        .counter-section h2 {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .counter-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* FIX: Dozaj kontrol i√ßin flexbox uyumu */
        #pumpsSection .counter-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: nowrap;
            gap: 10px;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
        }

        #decreaseBtn,
        #decreasePumpBtn {
            background: var(--danger-color);
        }

        #increaseBtn,
        #increasePumpBtn {
            background: var(--success-color);
        }

        .control-btn:disabled {
            opacity: 0.5;
        }

        .count-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            min-width: 30px;
            text-align: center;
        }

        /* Machines Container */
        .machines-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .machine-card {
            background: var(--bg-input);
            padding: 14px;
            border-radius: var(--border-radius-sm);
            border-left: 3px solid var(--primary-color);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .machine-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* FIX: Number badge removed */
        .machine-number {
            display: none;
        }

        .checklist {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .checklist-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .checklist-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            flex: 1;
        }

        .checklist-actions {
            display: flex;
            gap: 8px;
        }

        .check-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid #444;
            background: transparent;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .check-btn.pass.active {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        .check-btn.fail.active {
            background: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }

        /* Notes & Buttons */
        textarea {
            width: 100%;
            height: 100px;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid rgba(76, 201, 240, 0.2);
            border-radius: var(--border-radius-xs);
            color: white;
            resize: vertical;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .action-buttons button {
            padding: 16px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            color: white;
            cursor: pointer;
        }

        .primary-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: var(--bg-dark) !important;
        }

        .whatsapp-btn {
            background: #25D366;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(76, 201, 240, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .add-customer-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .add-customer-form input {
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid rgba(76, 201, 240, 0.2);
            color: white;
            border-radius: 8px;
        }

        .customer-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .customer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg-input);
            margin-bottom: 8px;
            border-radius: 8px;
        }

        .customer-actions button {
            margin-left: 5px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
        }

        @media (max-width: 480px) {
            .checklist {
                grid-template-columns: 1fr;
            }

            .machines-container {
                padding: 0 5px;
            }

            .counter-header {
                flex-wrap: nowrap;
                gap: 10px;
            }

            .counter-title h2 {
                font-size: 0.95rem;
            }

            .icon-box {
                font-size: 1.2rem;
            }
        }
    </style>
</head>

<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-logo">
                <img src="logo.png" alt="DozaTech">
            </div>
            <h2>Servis Formu Giri≈ü</h2>
            <input type="password" id="loginPassword" placeholder="≈ûifreniz" autocomplete="current-password">
            <div class="remember-me-container">
                <input type="checkbox" id="rememberMe" class="remember-checkbox">
                <label for="rememberMe" class="remember-label">Beni Hatƒ±rla</label>
            </div>
            <button id="loginBtn">Giri≈ü Yap</button>
            <p id="loginError" class="error-msg"></p>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <header class="logo-section">
            <div class="logo-container">
                <img src="logo.png" alt="DozaTech" class="logo-image">
                <img src="kase.jpg" id="kaseImage" style="display: none;" alt="Kase">
            </div>
        </header>

        <section class="customer-section">
            <h2>M√º≈üteri Se√ßimi</h2>
            <div class="customer-controls">
                <select id="customerSelect">
                    <option value="">-- Se√ßin --</option>
                </select>
                <button id="manageCustomersBtn" class="secondary-btn">Y√∂net</button>
            </div>
        </section>

        <!-- Dynamic Counter Section -->
        <div class="counter-section">
            <div class="counter-header">
                <div class="counter-title">
                    <div class="icon-box">üçΩÔ∏è</div>
                    <h2>Bula≈üƒ±k Makinesi</h2>
                </div>
                <div class="counter-controls">
                    <button class="control-btn" id="decreaseBtn" disabled>‚àí</button>
                    <span class="count-display" id="machineCount">0</span>
                    <button class="control-btn" id="increaseBtn">+</button>
                </div>
            </div>

            <div class="machines-container" id="machinesContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üçΩÔ∏è</div>
                    <p class="empty-state-text">Bula≈üƒ±k Makinesi eklemek i√ßin + tƒ±klayƒ±n</p>
                </div>
            </div>
        </div>

        <section class="notes-section">
            <h2>Genel Notlar</h2>
            <textarea id="generalNotes" placeholder="Buraya genel notlarƒ±nƒ±zƒ± yazabilirsiniz..."></textarea>
        </section>

        <div class="action-buttons">
            <button id="saveBtn" class="primary-btn">
                <span>PDF ƒ∞ndir</span>
            </button>
            <button id="sendBtn" class="whatsapp-btn">
                <span>WhatsApp G√∂nder</span>
            </button>
        </div>

        <footer>
            <p>¬© 2024 DozaTech - End√ºstriyel Mutfak √á√∂z√ºmleri</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="customerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>M√º≈üteri Y√∂netimi</h3>
                <button id="closeModalBtn" class="close-btn">&times;</button>
            </div>
            <div class="add-customer-form">
                <input type="text" id="customerName" placeholder="M√º≈üteri Adƒ±">
                <!-- Phone input removed -->
                <button id="addCustomerBtn"
                    style="background: linear-gradient(135deg, #06d6a0, #05b38a); color:white; padding:12px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Ekle</button>
            </div>
            <div id="customerList" class="customer-list"></div>
        </div>
    </div>

    <div id="editCustomerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>M√º≈üteri D√ºzenle</h3>
                <button id="closeEditModalBtn" class="close-btn">&times;</button>
            </div>
            <div class="add-customer-form">
                <input type="hidden" id="editCustomerId">
                <input type="text" id="editCustomerName" placeholder="M√º≈üteri Adƒ±">
                <!-- Phone input removed -->
                <button id="saveEditCustomerBtn" class="primary-btn" style="width:100%;">Kaydet</button>
            </div>
        </div>
    </div>

    <script>
        // === INLINED APP logic ===
        const APP_PASSWORD = 'Sam1089071261';
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const loginBtn = document.getElementById('loginBtn');
        const loginPassword = document.getElementById('loginPassword');
        const loginError = document.getElementById('loginError');
        const rememberMe = document.getElementById('rememberMe');

        // Initial Auth Check
        if (localStorage.getItem('dozatech_auth_permanent') === 'true' || sessionStorage.getItem('dozatech_auth') === 'true') {
            if (loginScreen) loginScreen.classList.add('hidden');
            if (appContainer) appContainer.style.display = 'block';
        }

        if (loginBtn) {
            loginBtn.addEventListener('click', handleLogin);
        }
        if (loginPassword) {
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        }

        function handleLogin() {
            const pwd = loginPassword.value;
            if (pwd === APP_PASSWORD) {
                // Sadece oturum s√ºresince hatƒ±rla (varsayƒ±lan)
                sessionStorage.setItem('dozatech_auth', 'true');

                // Eƒüer beni hatƒ±rla se√ßiliyse kalƒ±cƒ± hatƒ±rla
                if (rememberMe && rememberMe.checked) {
                    localStorage.setItem('dozatech_auth_permanent', 'true');
                }

                loginScreen.classList.add('hidden');
                appContainer.style.display = 'block';
                loginError.textContent = '';
            } else {
                loginError.textContent = 'Yanlƒ±≈ü ≈üifre!';
                loginPassword.value = '';
                if (navigator.vibrate) navigator.vibrate(100);
            }
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });

        // Checklists
        const checklistItems = [
            { id: 'yikama-suyu-isisi', label: 'Yƒ±kama suyu ƒ±sƒ±sƒ±' },
            { id: 'durulama-suyu-isisi', label: 'Durulama suyu ƒ±sƒ±sƒ±' },
            { id: 'yikama-kolu', label: 'Yƒ±kama kolu' },
            { id: 'durulama-kolu', label: 'Durulama kolu' },
            { id: 'kirec-bakimi', label: 'Kire√ß bakƒ±mƒ±' },
            { id: 'urunler-dogru-takili-mi', label: '√úr√ºnler doƒüru takƒ±lƒ± mƒ±' },
            { id: 'deterjan-kalintisi', label: 'Deterjan kalƒ±ntƒ±sƒ±' },
            { id: 'yikama-kalitesi', label: 'Yƒ±kama kalitesi' },
            { id: 'kurutma', label: 'Kurutma' }
        ];

        const pumpChecklistItems = [
            { id: 'deterjan-pompa', label: 'Deterjan pompa' },
            { id: 'parlatici-pompa', label: 'Parlatƒ±cƒ± pompa' },
            { id: 'hortumlar', label: 'Hortumlar' },
            { id: 'bidon-agirligi', label: 'Bidon aƒüƒ±rlƒ±ƒüƒ±' },
            { id: 'parlatici-cekwalf', label: 'Parlatƒ±cƒ± √ßekwalf' },
            { id: 'deterjan-girisi', label: 'Deterjan giri»ôi' },
            { id: 'sivi-kacagi', label: 'Sƒ±vƒ± ka√ßaƒüƒ±' },
            { id: 'pompa-askisi', label: 'Pompa askƒ±sƒ±' }
        ];

        let machineCount = 0; const machineStates = {};
        let pumpCount = 0; const pumpStates = {};
        let customers = []; let selectedCustomerId = null;

        // Elements
        const decreaseBtn = document.getElementById('decreaseBtn');
        const increaseBtn = document.getElementById('increaseBtn');
        const countDisplay = document.getElementById('machineCount');
        const machinesContainer = document.getElementById('machinesContainer');
        const generalNotes = document.getElementById('generalNotes');
        const customerSelect = document.getElementById('customerSelect');
        const saveBtn = document.getElementById('saveBtn');
        const sendBtn = document.getElementById('sendBtn');
        const customerModal = document.getElementById('customerModal');
        const editCustomerModal = document.getElementById('editCustomerModal');
        const manageCustomersBtn = document.getElementById('manageCustomersBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeEditModalBtn = document.getElementById('closeEditModalBtn');
        const addCustomerBtn = document.getElementById('addCustomerBtn');
        const saveEditCustomerBtn = document.getElementById('saveEditCustomerBtn');
        const customerNameInput = document.getElementById('customerName');
        const customerPhoneInput = document.getElementById('customerPhone');
        const editCustomerIdInput = document.getElementById('editCustomerId');
        const editCustomerNameInput = document.getElementById('editCustomerName');
        const editCustomerPhoneInput = document.getElementById('editCustomerPhone');
        const customerListContainer = document.getElementById('customerList');

        // Dynamic Dosage Pump Elements
        let decreasePumpBtn, increasePumpBtn, pumpCountDisplay, pumpsContainer;

        function init() {
            // Inject Pump HTML
            if (!document.getElementById('pumpsSection')) {
                const pumpHTML = `
                <div class="counter-section" id="pumpsSection" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                    <div class="counter-header">
                        <div class="counter-title">
                            <div class="icon-box">üí¶</div>
                            <h2>Dozaj Pompasƒ±</h2>
                        </div>
                        <div class="counter-controls">
                            <button class="control-btn" id="decreasePumpBtn" disabled>‚àí</button>
                            <span class="count-display" id="pumpCount">0</span>
                            <button class="control-btn" id="increasePumpBtn">+</button>
                        </div>
                    </div>
                    <div class="machines-container" id="pumpsContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¶</div>
                            <p class="empty-state-text">Pompa eklemek i√ßin + tƒ±klayƒ±n</p>
                        </div>
                    </div>
                </div>
                `;
                machinesContainer.insertAdjacentHTML('afterend', pumpHTML);
            }

            decreasePumpBtn = document.getElementById('decreasePumpBtn');
            increasePumpBtn = document.getElementById('increasePumpBtn');
            pumpCountDisplay = document.getElementById('pumpCount');
            pumpsContainer = document.getElementById('pumpsContainer');

            loadState();
            updateUI();
            updatePumpUI();
            renderCustomerSelect();
            setupEventListeners();
            registerServiceWorker();
        }

        function setupEventListeners() {
            decreaseBtn.addEventListener('click', decreaseMachineCount);
            increaseBtn.addEventListener('click', increaseMachineCount);

            // Re-bind pump listeners (important because elemenets might be recreated)
            if (decreasePumpBtn) decreasePumpBtn.addEventListener('click', decreasePumpCount);
            if (increasePumpBtn) increasePumpBtn.addEventListener('click', increasePumpCount);

            generalNotes.addEventListener('input', saveState);
            customerSelect.addEventListener('change', e => { selectedCustomerId = e.target.value || null; saveState(); });
            saveBtn.addEventListener('click', handleSavePDF);
            sendBtn.addEventListener('click', handleSendWhatsApp);

            manageCustomersBtn.addEventListener('click', () => {
                customerModal.style.display = 'flex';
                renderCustomerList();
                customerModal.classList.add('show');
            });
            closeModalBtn.addEventListener('click', () => {
                customerModal.style.display = 'none';
                customerModal.classList.remove('show');
            });
            addCustomerBtn.addEventListener('click', addCustomer);

            closeEditModalBtn.addEventListener('click', () => {
                editCustomerModal.style.display = 'none';
                editCustomerModal.classList.remove('show');
            });
            saveEditCustomerBtn.addEventListener('click', saveEditedCustomer);

            customerModal.addEventListener('click', e => { if (e.target === customerModal) customerModal.style.display = 'none'; });
            editCustomerModal.addEventListener('click', e => { if (e.target === editCustomerModal) editCustomerModal.style.display = 'none'; });
        }

        // --- LOGIC FUNCTIONS ---
        function loadState() {
            try {
                const saved = localStorage.getItem('dozatech_state_v3');
                if (saved) {
                    const data = JSON.parse(saved);
                    machineCount = data.machineCount || 0;
                    customers = data.customers || [];
                    selectedCustomerId = data.selectedCustomerId || null;
                    if (data.generalNotes) generalNotes.value = data.generalNotes;
                    Object.assign(machineStates, data.machineStates || {});

                    pumpCount = data.pumpCount || 0;
                    Object.assign(pumpStates, data.pumpStates || {});
                }
            } catch (e) {
                console.error(e);
            }
        }

        function saveState() {
            const data = {
                machineCount,
                customers,
                selectedCustomerId,
                generalNotes: generalNotes.value,
                machineStates,
                pumpCount,
                pumpStates
            };
            localStorage.setItem('dozatech_state_v3', JSON.stringify(data));
        }

        function updateUI() {
            countDisplay.textContent = machineCount;
            decreaseBtn.disabled = machineCount === 0;

            machinesContainer.innerHTML = '';
            if (machineCount === 0) {
                machinesContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üçΩÔ∏è</div><p class="empty-state-text">Bula≈üƒ±k Makinesi eklemek i√ßin + tƒ±klayƒ±n</p></div>';
                return;
            }

            for (let i = 1; i <= machineCount; i++) {
                const section = document.createElement('div');
                section.className = 'machine-card';
                if (!machineStates[i]) machineStates[i] = {};

                let html = `
                <div class="machine-header">
                    <span class="machine-title">Bula≈üƒ±k Makinesi ${i}</span>
                </div>
                <div class="checklist">`;

                checklistItems.forEach(item => {
                    const status = machineStates[i][item.id];
                    const passClass = status === 'ok' ? 'active' : '';
                    const failClass = status === 'fail' ? 'active' : '';

                    html += `
                    <div class="checklist-item">
                        <span class="checklist-label">${item.label}</span>
                        <div class="checklist-actions">
                            <button class="check-btn pass ${passClass}" onclick="setCheck(1, ${i}, '${item.id}', 'ok')">‚úì</button>
                            <button class="check-btn fail ${failClass}" onclick="setCheck(1, ${i}, '${item.id}', 'fail')">‚úó</button>
                        </div>
                    </div>`;
                });

                html += `</div>`;
                section.innerHTML = html;
                machinesContainer.appendChild(section);
            }
        }

        function updatePumpUI() {
            if (!pumpCountDisplay) return;
            pumpCountDisplay.textContent = pumpCount;
            decreasePumpBtn.disabled = pumpCount === 0;

            pumpsContainer.innerHTML = '';
            if (pumpCount === 0) {
                pumpsContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¶</div><p class="empty-state-text">Pompa eklemek i√ßin + tƒ±klayƒ±n</p></div>';
                return;
            }

            for (let i = 1; i <= pumpCount; i++) {
                const section = document.createElement('div');
                section.className = 'machine-card';
                section.style.borderLeftColor = '#0077b6';
                if (!pumpStates[i]) pumpStates[i] = {};

                let html = `
                <div class="machine-header">
                    <span class="machine-title">Dozaj Pompasƒ± ${i}</span>
                </div>
                <div class="checklist">`;

                pumpChecklistItems.forEach(item => {
                    const status = pumpStates[i][item.id];
                    const passClass = status === 'ok' ? 'active' : '';
                    const failClass = status === 'fail' ? 'active' : '';

                    html += `
                    <div class="checklist-item">
                        <span class="checklist-label">${item.label}</span>
                        <div class="checklist-actions">
                            <button class="check-btn pass ${passClass}" onclick="setCheck(2, ${i}, '${item.id}', 'ok')">‚úì</button>
                            <button class="check-btn fail ${failClass}" onclick="setCheck(2, ${i}, '${item.id}', 'fail')">‚úó</button>
                        </div>
                    </div>`;
                });

                html += `</div>`;
                section.innerHTML = html;
                pumpsContainer.appendChild(section);
            }
        }

        // type: 1=Bula≈üƒ±k, 2=Pompa
        function setCheck(type, machineIndex, itemId, status) {
            const targetStates = type === 1 ? machineStates : pumpStates;

            if (targetStates[machineIndex][itemId] === status) {
                targetStates[machineIndex][itemId] = null;
            } else {
                targetStates[machineIndex][itemId] = status;
            }
            saveState();
            if (type === 1) updateUI(); else updatePumpUI();
        }

        function increaseMachineCount() {
            machineCount++;
            saveState();
            updateUI();
        }

        function decreaseMachineCount() {
            if (machineCount > 0) {
                delete machineStates[machineCount];
                machineCount--;
                saveState();
                updateUI();
            }
        }

        function increasePumpCount() {
            pumpCount++;
            saveState();
            updatePumpUI();
        }

        function decreasePumpCount() {
            if (pumpCount > 0) {
                delete pumpStates[pumpCount];
                pumpCount--;
                saveState();
                updatePumpUI();
            }
        }

        // Reset form fields (after PDF or when app closes)
        function resetFormFields() {
            // Reset machine count and states
            machineCount = 0;
            for (let key in machineStates) {
                delete machineStates[key];
            }

            // Reset pump count and states
            pumpCount = 0;
            for (let key in pumpStates) {
                delete pumpStates[key];
            }

            // Reset notes
            generalNotes.value = '';

            // Reset selected customer
            selectedCustomerId = null;
            customerSelect.value = '';

            // Save the reset state
            saveState();

            // Update UI
            updateUI();
            updatePumpUI();
        }

        // Reset form when app goes to background or is closed
        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'hidden') {
                resetFormFields();
            }
        });

        function addCustomer() {
            const name = customerNameInput.value.trim();
            if (!name) { alert('L√ºtfen m√º≈üteri adƒ±nƒ± girin.'); return; }
            // Phone removed
            const phone = "";
            customers.push({ id: Date.now().toString(), name, phone });
            saveState();
            renderCustomerList();
            renderCustomerSelect();
            customerNameInput.value = '';
            <!-- Phone input removed -->
        }

        function deleteCustomer(id) {
            if (confirm('Silmek istediƒüinize emin misiniz?')) {
                customers = customers.filter(c => c.id !== id);
                if (selectedCustomerId === id) { selectedCustomerId = null; customerSelect.value = ''; }
                saveState();
                renderCustomerList();
                renderCustomerSelect();
            }
        }

        function openEditCustomerModal(id) {
            const c = customers.find(x => x.id === id);
            if (!c) return;
            editCustomerIdInput.value = c.id;
            editCustomerNameInput.value = c.name;
            editCustomerPhoneInput.value = c.phone;
            editCustomerModal.style.display = 'flex';
            editCustomerModal.classList.add('show');
        }

        function saveEditedCustomer() {
            const id = editCustomerIdInput.value;
            const name = editCustomerNameInput.value.trim();
            if (!name) { alert('L√ºtfen m√º≈üteri adƒ±nƒ± girin.'); return; }
            // Phone removed
            const phone = "";
            const idx = customers.findIndex(c => c.id === id);
            if (idx > -1) {
                customers[idx] = { id, name, phone };
                saveState();
                renderCustomerList();
                renderCustomerSelect();
                editCustomerModal.style.display = 'none';
                editCustomerModal.classList.remove('show');
            }
        }

        function renderCustomerList() {
            if (customers.length === 0) {
                customerListContainer.innerHTML = '<div class="customer-list-empty"><p>Hen√ºz m√º≈üteri yok</p></div>';
                return;
            }
            customerListContainer.innerHTML = customers.map(c => `
                <div class="customer-item">
                    <div class="customer-info" style="color:white;">
                        <div class="customer-name" style="font-weight:bold;">${c.name}</div>
                    </div>
                    <div class="customer-actions">
                        <button class="customer-action-btn edit" onclick="openEditCustomerModal('${c.id}')">‚úèÔ∏è</button>
                        <button class="customer-action-btn delete" onclick="deleteCustomer('${c.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCustomerSelect() {
            let html = '<option value="">-- Se√ßin --</option>';
            customers.forEach(c => {
                html += `<option value="${c.id}" ${c.id === selectedCustomerId ? 'selected' : ''}>${c.name}</option>`;
            });
            customerSelect.innerHTML = html;
            // Also select the value
            customerSelect.value = selectedCustomerId || "";
        }

        // === PDF LOGIC ===
        function getImageDataUrl(selector) {
            const img = document.querySelector(selector);
            if (!img) return null;
            try {
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                return canvas.toDataURL('image/png');
            } catch (e) {
                return null;
            }
        }

        function generatePDFBlob() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add custom font if available
            if (window.pdfFont) {
                doc.addFileToVFS("Roboto-Regular.ttf", window.pdfFont);
                doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
                doc.setFont("Roboto");
            } else {
                doc.setFont('helvetica');
            }

            const customer = customers.find(c => c.id === selectedCustomerId);
            const date = new Date().toLocaleDateString('tr-TR');
            const time = new Date().toLocaleTimeString('tr-TR');
            const pw = doc.internal.pageSize.width;
            const ph = doc.internal.pageSize.height;
            // FIX: PDF Colors match BG (#0a0a14 = 10,10,20)
            const colDark = [10, 10, 20];
            const colPrimary = [76, 201, 240];
            const colAccent = [67, 97, 238];
            let y = 0;

            // HEADER
            doc.setFillColor(...colDark);
            doc.rect(0, 0, pw, 45, 'F');
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(15, 10, 50, 25, 4, 4, 'F');
            const logoData = getImageDataUrl('.logo-image');
            if (logoData) {
                try {
                    const imgProps = doc.getImageProperties(logoData);
                    const ratio = imgProps.height / imgProps.width;
                    const logoW = 40; const logoH = logoW * ratio;
                    const logoY = 10 + (25 - logoH) / 2;
                    doc.addImage(logoData, 'PNG', 20, logoY, logoW, logoH);
                } catch (e) { }
            }
            doc.setTextColor(255, 255, 255); doc.setFontSize(24); if (window.pdfFont) doc.setFont('Roboto', 'normal'); // Bold not available in subset
            doc.text('SERVƒ∞S FORMU', pw - 15, 22, { align: 'right' });
            doc.setTextColor(...colPrimary); doc.setFontSize(10);
            doc.text(`Tarih: ${date}   Saat: ${time}`, pw - 15, 32, { align: 'right' });
            doc.setDrawColor(...colPrimary); doc.setLineWidth(0.5); doc.line(15, 45, pw - 15, 45);

            y = 60;

            // DISHWASHER
            if (machineCount > 0) {
                doc.setTextColor(...colDark); doc.setFontSize(14);
                doc.text(`BULA≈ûIK MAKƒ∞NELERƒ∞ (${machineCount})`, 15, y);
                doc.setDrawColor(...colPrimary); doc.line(15, y + 3, 100, y + 3);
                y += 15;
                for (let i = 1; i <= machineCount; i++) {
                    if (y > 230) { doc.addPage(); y = 20; }
                    doc.setFillColor(...colPrimary); doc.roundedRect(15, y, pw - 30, 8, 2, 2, 'F');
                    doc.setTextColor(...colDark); doc.setFontSize(10);
                    doc.text(`Bula≈üƒ±k Makinesi ${i}`, 20, y + 5.5);
                    y += 15; // FIX: Increased distance (same as Pump)

                    const state = machineStates[i] || {};
                    doc.setFontSize(9);
                    let xPos = 20;

                    checklistItems.forEach((item, index) => {
                        const status = state[item.id];
                        doc.setFillColor(255, 255, 255);
                        if (status === 'ok') doc.setFillColor(46, 204, 113); // Green
                        if (status === 'fail') doc.setFillColor(239, 71, 111); // Red
                        if (status) {
                            doc.circle(xPos + 2, y - 1, 3, 'F'); doc.setTextColor(255, 255, 255); doc.setFontSize(7);
                            const mark = status === 'ok' ? 'V' : 'X'; doc.text(mark, xPos + 2, y, { align: 'center' });
                        } else {
                            doc.setDrawColor(200, 200, 200); doc.circle(xPos + 2, y - 1, 3, 'S');
                        }
                        doc.setTextColor(80, 80, 80); doc.setFontSize(9); doc.text(item.label, xPos + 7, y);
                        // FIX: Increased row spacing to avoid "dip dibe" look
                        if (index % 2 === 0) xPos = pw / 2 + 5; else { xPos = 20; y += 8; }
                    });
                    if (checklistItems.length % 2 !== 0) y += 8; y += 10;
                }
                y += 10;
            }

            // DOSAGE PUMP
            if (pumpCount > 0) {
                if (y > 230) { doc.addPage(); y = 20; }
                doc.setTextColor(...colDark); doc.setFontSize(14);
                doc.text(`DOZAJ POMPALARI (${pumpCount})`, 15, y);
                doc.setDrawColor(...colPrimary); doc.line(15, y + 3, 100, y + 3);
                y += 15;
                for (let i = 1; i <= pumpCount; i++) {
                    if (y > 230) { doc.addPage(); y = 20; }
                    doc.setFillColor(...colAccent); doc.roundedRect(15, y, pw - 30, 8, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255); doc.setFontSize(10);
                    doc.text(`Dozaj Pompasƒ± ${i}`, 20, y + 5.5);
                    y += 15;

                    const state = pumpStates[i] || {};
                    doc.setFontSize(9);
                    let xPos = 20;
                    pumpChecklistItems.forEach((item, index) => {
                        const status = state[item.id];
                        doc.setFillColor(255, 255, 255);
                        if (status === 'ok') doc.setFillColor(46, 204, 113);
                        if (status === 'fail') doc.setFillColor(239, 71, 111);
                        if (status) {
                            doc.circle(xPos + 2, y - 1, 3, 'F'); doc.setTextColor(255, 255, 255); doc.setFontSize(7);
                            const mark = status === 'ok' ? 'V' : 'X'; doc.text(mark, xPos + 2, y, { align: 'center' });
                        } else {
                            doc.setDrawColor(200, 200, 200); doc.circle(xPos + 2, y - 1, 3, 'S');
                        }
                        doc.setTextColor(80, 80, 80); doc.setFontSize(9); doc.text(item.label, xPos + 7, y);
                        // FIX: Increased row spacing
                        if (index % 2 === 0) xPos = pw / 2 + 5; else { xPos = 20; y += 8; }
                    });
                    if (pumpChecklistItems.length % 2 !== 0) y += 8; y += 10;
                }
            }

            // NOTES
            if (generalNotes.value.trim()) {
                if (y > 220) { doc.addPage(); y = 20; }
                const txt = generalNotes.value;
                doc.setFontSize(10); doc.setTextColor(...colDark); doc.text('NOTLAR:', 15, y); y += 6;
                doc.setFontSize(9);
                const lines = doc.splitTextToSize(txt, pw - 30);
                doc.setFillColor(250, 250, 250); doc.setDrawColor(230, 230, 230);
                const boxH = Math.max(15, lines.length * 5 + 10);
                doc.rect(15, y, pw - 30, boxH, 'FD');
                doc.setTextColor(50, 50, 50); doc.text(lines, 20, y + 6); y += boxH + 15;
            } else { y += 10; }

            // SIGNATURES
            if (y > ph - 70) { doc.addPage(); y = 20; }
            const bottomY = Math.max(y, ph - 80);
            doc.setTextColor(...colDark); doc.setFontSize(10);
            doc.text('DozaTech Teknik Servis', 40, bottomY + 5, { align: 'center' });

            // Stamp
            const stampData = getImageDataUrl('#kaseImage');
            if (stampData) {
                try {
                    const sProps = doc.getImageProperties(stampData);
                    const sRatio = sProps.height / sProps.width;
                    const sW = 40; const sH = sW * sRatio;
                    doc.addImage(stampData, 'JPEG', 20, bottomY + 8, sW, sH);
                } catch (e) { }
            } else { doc.text('ƒ∞mza / Ka≈üe', 40, bottomY + 30, { align: 'center' }); }

            doc.text('M√º≈üteri', pw - 45, bottomY + 5, { align: 'center' });

            // FIX: Customer Name moved UP closer to signature area
            if (customer) {
                doc.setFontSize(9);
                // bottomY + 5 is "Musteri" text. Changed to +15 to be much closer as requested
                doc.text(customer.name, pw - 45, bottomY + 15, { align: 'center' });
            }
            // FIX: Removed the line
            // doc.setDrawColor(150, 150, 150); doc.line(pw - 70, bottomY + 35, pw - 20, bottomY + 35);

            // FOOTER
            doc.setFillColor(...colDark); doc.rect(0, ph - 15, pw, 15, 'F');
            doc.setTextColor(150, 150, 150); doc.setFontSize(8);
            const safeName = customer ? customer.name.replace(/\s+/g, '_') : 'Musteri';
            const fn = `servisformu_${safeName}_${date.replace(/\./g, '-')}.pdf`;
            doc.text('DozaTech - End√ºstriyel Mutfak √á√∂z√ºmleri', pw / 2, ph - 9, { align: 'center' });
            doc.text('Bu form dijital olarak olu≈üturulmu≈ütur.', pw / 2, ph - 5, { align: 'center' });

            return { blob: doc.output('blob'), fileName: fn };
        }

        function handleSavePDF() {
            showToast('PDF olu≈üturuluyor...');
            try {
                const { blob, fileName } = generatePDFBlob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = fileName; a.style.display = 'none';
                document.body.appendChild(a); a.click();
                setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 200);
                showToast('PDF indirildi.');
                // Reset form after successful PDF download
                resetFormFields();
            } catch (error) { console.error(error); showToast('Hata: ' + error.message); }
        }

        function handleSendWhatsApp() {
            const customer = customers.find(c => c.id === selectedCustomerId);
            if (!customer) { alert('L√ºtfen m√º≈üteri se√ßin.'); return; }
            if (!customer.phone) { alert('M√º≈üterinin telefon numarasƒ± kayƒ±tlƒ± deƒüil. L√ºtfen m√º≈üteri bilgilerini g√ºncelleyin.'); return; }
            try {
                const { blob, fileName } = generatePDFBlob();
                const file = new File([blob], fileName, { type: 'application/pdf' });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    const noteText = customer.name;
                    navigator.share({ files: [file], title: noteText, text: noteText })
                        .then(() => { resetFormFields(); }) // Reset after successful share
                        .catch(e => { if (e.name !== 'AbortError') openWA(customer, blob, fileName); });
                } else { openWA(customer, blob, fileName); }
                // Reset form after WhatsApp action initiated
                resetFormFields();
            } catch (error) { showToast('Hata: ' + error.message); }
        }

        function openWA(customer, blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = fileName;
            document.body.appendChild(a); a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 200);
            const msg = customer.name;
            setTimeout(() => { window.open('https://wa.me/' + customer.phone + '?text=' + encodeURIComponent(msg), '_blank'); }, 500);
        }

        function showToast(msg) {
            alert(msg); // Simple alert for reliability
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                // Register simplified SW
                navigator.serviceWorker.register('sw.js').catch(e => console.log(e));
            }
        }

        // Global Exports
        window.increaseMachineCount = increaseMachineCount;
        window.decreaseMachineCount = decreaseMachineCount;
        window.increasePumpCount = increasePumpCount;
        window.decreasePumpCount = decreasePumpCount;
        window.setCheck = setCheck;
        window.addCustomer = addCustomer;
        window.deleteCustomer = deleteCustomer;
        window.openEditCustomerModal = openEditCustomerModal;
        window.saveEditedCustomer = saveEditedCustomer;

        // Start
        init();
    </script>
</body>

</html>